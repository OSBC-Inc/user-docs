# 취약점 스캔으로 컨테이너 전달 파이프라인 설정

이제 우리는 컨테이너 빌드 및 실행을 알았으므로 적극적으로 개발 중인 `dev` 태그와 컨테이너의 PROD 지원 버전을 구별하기 위해 전달 파이프라인을 설정할 것입니다.

Git 분기를 사용하여 코드의 이 두 가지 상태를 추적합니다.

## PROD 코드용 GitHub branch 만들기

GitHub에서 새 branch를 만듭니다. 그것을 PROD라고 부르십시오.

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/gh-create-prodbranch.png)

지금은 여기까지입니다! 이제 Docker Hub에서 파이프라인의 CD 부분을 설정하겠습니다.

## 지속적 전달을 위한 Docker Hub 구성

변경 사항이 리포지토리의 PROD 분기에 푸시될 때마다 Docker Hub의 Autobuild를 사용하여 PROD 컨테이너를 다시 빌드할 수 있습니다. 마지막 단계에서 만든 `goof` 컨테이너의 저장소로 이동합니다.

### 선택 사항: 취약점 검색 활성화

{% hint style="info" %}
이 단계에는 유료 Docker Hub 구독이 필요합니다.
{% endhint %}

Repository settings로 이동한 다음 단추를 클릭하여 취약점 검색을 활성화합니다.

![저장소 설정에서 이미지 스캔 활성화](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/hub-repo-enable-scans.png)

Docker Hub는 이미지가 Docker Hub로 푸시될 때 Snyk를 사용하여 취약성을 스캔합니다. Autobuild와 결합된 Docker Hub는 PROD 컨테이너가 다시 빌드될 때마다 취약점 수를 업데이트합니다.

### GitHub 리포지토리의 PROD branch에 대한 AutoBuild 구성

다음으로 `Builds`로 이동합니다. AutoBuild에서는 Docker Hub를 GitHub에 연결해야 합니다.

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/dockerhub-configurescm.png)

드롭다운 목록에서 GitHub 저장소를 선택합니다.

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/dockerhub-chooserepo.png)

PROD 분기를 사용하고 빌드된 이미지 PROD에 태그를 지정하도록 규칙을 구성합니다. 빌드를 트리거합니다.

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/dockerhub-choosegitbranch.png)

Autobuild가 완료되면 이전에 저장소 개요 탭에서 푸시한 dev 컨테이너 옆에 PROD 컨테이너와 해당 취약점이 표시됩니다.

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/dockerhub-tagvulns.png)

컨테이너에는 많은 취약점이 있습니다! PROD가 이를 포착할 때까지 기다리는 것은 좋지 않으므로 풀 요청 프로세스의 일부로 취약점을 포착하기 위해 GitHub Actions로 CI 워크플로를 설정합니다.

## GitHub Actions로 CI 및 Snyk 스캔 설정

샘플 리포지토리에는 풀 요청이 PROD 분기에 대해 열릴 때 실행되는 두 개의 GitHub Actions 템플릿이 포함되어 있습니다. 저장소의 `.github/workflows` 폴더에서 찾을 수 있습니다.

* 사용 가능한 수정 사항이 있는 심각도가 높은 취약점이 발견되면 첫 번째는 실패합니다.
* 두 번째는 애플리케이션과 컨테이너를 빌드한 다음 Snyk 컨테이너로 스캔합니다.

컨테이너 작업은 코드 변경 후 애플리케이션이 올바르게 빌드되도록 보장하고 취약성이 있는 경우 확인에 실패하지 않습니다.

{% tabs %}
{% tab title="Snyk Open Source" %}
```
name: Check for Open Source Vulnerabilities with Snyk
on: 
  pull_request:
    branches:
      PROD
jobs:
  oss-security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Check for High Severity OSS Vulnerabilities
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --fail-on=upgradable
```
{% endtab %}

{% tab title="CI + Snyk Container" %}
```
name: CI task for PROD branch

on:
  pull_request:
    branches: [ PROD ]

jobs:
  build_app:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    - run: npm ci
    - run: npm run build --if-present
  build_container:
    needs: [build_app]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Build Docker Image
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          push: false
          load: true
          tags: goof:PROD         
      - name: Snyk Container Test
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ Secrets.SNYK_TOKEN }}
        with:
          image: goof:PROD
          args: --file=Dockerfile
      - name: Upload Container Scan results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: snyk.sarif
```
{% endtab %}
{% endtabs %}

이러한 워크플로를 사용하려면 Snyk 토큰을 GitHub에 저장해야 합니다.

#### Snyk 토큰 검색

다음 두 가지 방법 중 하나로 API 토큰을 찾을 수 있습니다:

* Snyk CLI가 있는 경우 `snyk config get api`를 실행하여 검색합니다.
* Snyk UI에서 계정 설정 페이지로 이동하여 검색합니다.

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/snyk-token.png)

{% hint style="info" %}
토큰을 확인할 수 없습니까? [Snyk API 토큰 취소 및 재생성](https://support.snyk.io/hc/en-us/articles/360004008278-Revoking-and-regenerating-Snyk-API-tokens)을 확인하십시오.
{% endhint %}

#### GitHub Secrets에 Snyk 토큰 저장

Settings -> Secrets -> New Repository Secret으로 이동하여 Forked Repo의 암호에 토큰을 저장합니다. 암호 이름 **SNYK\_TOKEN**

![](https://partner-workshop-assets.s3.us-east-2.amazonaws.com/gh-secrets.png)

{% hint style="info" %}
암호를 확인할 수 없습니까? [저장소에 대한 암호화된 암호 만들기](https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository)를 확인하십시오.
{% endhint %}

빌드 및 테스트 인프라가 준비되면 컨테이너 취약성 수정을 시작할 수 있습니다!
